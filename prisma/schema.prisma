generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USER & AUTHENTICATION MODELS
// ========================================

enum ReportStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  FLAGGED
  COMPLETED
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

enum RetrainStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum ProductionStage {
  CANARY
  PRODUCTION
  STAGING
}

enum SLATaskStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  ESCALATED
  CLOSED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  role      Role     @default(USER)
  customerId         String?
  subscriptionStatus String? @default("inactive")

  aiTrainingExamples AITrainingExample[] @relation("UserAITrainingExamples")
  subscriptions      Subscription[]
  invoices           Invoice[]

  @@index([createdAt])
}

enum Role {
  USER
  ADMIN
}

model Audit {
  id        String   @id @default(cuid())
  action    String
  actor     String?
  detail    Json?
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model AITrainingExample {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("UserAITrainingExamples", fields: [userId], references: [id])
  // Add other fields here

  @@index([userId])
}

model Invoice {
  id               String   @id @default(uuid())
  customer         Customer @relation(fields: [customerId], references: [id])
  customerId       String
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id])
  subscriptionId   String?
  stripeInvoiceId  String   @unique
  amountTotal      Int?
  currency         String?
  status           String?
  hostedInvoiceUrl String?
  s3Key            String?
  createdAt        DateTime @default(now())
}

model Jurisdiction {
  id                 String              @id @default(uuid())
  name               String
  projects           Project[]           @relation("JurisdictionProjects")
  permitTypes        PermitType[]
  permitRequirements PermitRequirement[] @relation("JurisdictionPermitRequirements")

  @@index([name])
}

model Project {
  id             String       @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction @relation("JurisdictionProjects", fields: [jurisdictionId], references: [id])
  // Add other fields here

  @@index([jurisdictionId])
}

model PermitRequirement {
  id             String       @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction @relation("JurisdictionPermitRequirements", fields: [jurisdictionId], references: [id])
  // Add other fields here

  @@index([jurisdictionId])
}

model PermitType {
  id             String       @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction @relation(fields: [jurisdictionId], references: [id])

  @@index([jurisdictionId])
}

model AlertRule {
  id          String   @id @default(uuid())
  scope       String   @default("global")
  scopeRef    String?
  kind        String   @default("forecast_spike")
  threshold   Float    @default(0.2)
  windowHours Int      @default(24)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([scope])
  @@index([active])
  @@index([createdAt])
}

model ForecastLog {
  id          String   @id @default(cuid())
  triggeredAt DateTime @default(now())
  results     Json

  @@index([triggeredAt])
}

model SLATask {
  id           String   @id @default(cuid())
  title        String
  description  String
  priority     String
  dueAt        DateTime
  assignedTeam String?
  status       String
  type         String
  createdAt    DateTime @default(now())

  @@index([dueAt])
  @@index([status])
  @@index([assignedTeam])
}

model SLASettings {
  id        String @id @default(cuid())
  category  String
  threshold Int
  teamId    String?

  @@index([category])
  @@index([teamId])
}

model ProductionModel {
  id           String   @id @default(cuid())
  modelVersion String   @unique
  stage        String
  deployedBy   String?
  deployedAt   DateTime @default(now())
  metadata     Json?

  @@index([stage])
}

model Subscription {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id])
  stripeCustomerId      String
  stripeSubscriptionId  String   @unique
  status                String
  planId                String?
  currentPeriodEnd      DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model Invoice {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  stripeInvoiceId  String   @unique
  amountTotal      Int?
  currency         String?
  status           String?
  hostedInvoiceUrl String?
  s3Key            String?  // Added for PDF archival
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// =========================
// Audit middleware note
// =========================
// After this schema is migrated, Cursor can add lib/prisma-middleware.ts
// to log all create/update/delete actions to the Audit table.
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USER & AUTHENTICATION MODELS
// ========================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  role      Role     @default(USER)
  customerId         String?
  subscriptionStatus String? @default("inactive")

  aiTrainingExamples AITrainingExample[] @relation("UserAITrainingExamples")
  subscriptions      Subscription[]
  invoices           Invoice[]
}

enum Role {
  USER
  ADMIN
}

model Audit {
  id        String   @id @default(cuid())
  action    String
  actor     String?
  detail    Json?
  createdAt DateTime @default(now())
}

model AITrainingExample {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("UserAITrainingExamples", fields: [userId], references: [id])
  // add other fields here
}

model Jurisdiction {
  id                 String              @id @default(uuid())
  name               String
  projects           Project[]           @relation("JurisdictionProjects")
  permitTypes        PermitType[]
  permitRequirements PermitRequirement[] @relation("JurisdictionPermitRequirements")
}

model Project {
  id             String       @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction @relation("JurisdictionProjects", fields: [jurisdictionId], references: [id])
  // add other fields here
}

model Report {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  address   String
  status    String   @default("pending")
  createdAt DateTime @default(now())
}

model PermitRequirement {
  id             String       @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction @relation("JurisdictionPermitRequirements", fields: [jurisdictionId], references: [id])
  // add other fields here
}

model PermitType {
  id             String       @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction @relation(fields: [jurisdictionId], references: [id])
}

model AlertRule {
  id          String   @id @default(uuid())
  scope       String   @default("global")
  scopeRef    String?
  kind        String   @default("forecast_spike")
  threshold   Float    @default(0.2)
  windowHours Int      @default(24)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model ForecastLog {
  id          String   @id @default(cuid())
  triggeredAt DateTime @default(now())
  results     Json
}

model SLATask {
  id           String   @id @default(cuid())
  title        String
  description  String
  priority     String
  dueAt        DateTime
  assignedTeam String?
  status       String
  type         String
  createdAt    DateTime @default(now())
}

model SLASettings {
  id        String @id @default(cuid())
  category  String
  threshold Int
  teamId    String?
}

model ProductionModel {
  id           String   @id @default(cuid())
  modelVersion String   @unique
  stage        String
  deployedBy   String?
  deployedAt   DateTime @default(now())
  metadata     Json?
}

model Subscription {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id])
  stripeCustomerId      String
  stripeSubscriptionId  String   @unique
  status                String
  planId                String?
  currentPeriodEnd      DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Invoice {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  stripeInvoiceId  String   @unique
  amountTotal      Int?
  currency         String?
  status           String?
  hostedInvoiceUrl String?
  createdAt        DateTime @default(now())
}

// ========================================
// FORM SUBMISSIONS
// ========================================

model FormSubmission {
  id                 String   @id @default(cuid())
  type               String
  applicantName      String
  address            String
  phone              String
  email              String
  projectDescription String?
  serviceAmperage    Int?
  fixtures           Int?
  equipmentType      String?
  btuRating          Int?
  squareFootage      Int?
  estimatedValue     Int?
  contractorName     String
  contractorLicense  String
  createdAt          DateTime @default(now())
}
