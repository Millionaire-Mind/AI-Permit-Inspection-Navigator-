generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USER & AUTHENTICATION MODELS
// ========================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  role      Role     @default(USER)
  stripeCustomerId   String?
  subscriptionStatus String? @default("inactive")

  aiTrainingExamples AITrainingExample[] @relation("UserAITrainingExamples")
  subscriptions      Subscription[]
  invoices           Invoice[]
  applications       PermitApplication[]

  @@index([email])
  @@index([stripeCustomerId])
}

enum Role {
  USER
  ADMIN
}

enum ApplicationStatus {
  SUBMITTED
  VALIDATION_FAILED
  IN_REVIEW
  APPROVED
  REJECTED
}

model Audit {
  id        String   @id @default(cuid())
  action    String
  actor     String?
  detail    Json?
  createdAt DateTime @default(now())
}

model AITrainingExample {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("UserAITrainingExamples", fields: [userId], references: [id])
  // add other fields here
}

model Jurisdiction {
  id                 String              @id @default(uuid())
  name               String
  projects           Project[]           @relation("JurisdictionProjects")
  permitTypes        PermitType[]
  permitRequirements PermitRequirement[] @relation("JurisdictionPermitRequirements")
  /** Optional normalized location code, e.g., 'seattle-wa' */
  slug               String?  @unique
}

model Project {
  id             String       @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction @relation("JurisdictionProjects", fields: [jurisdictionId], references: [id])
  /** Optional normalized project type string, e.g., 'residential_remodel', 'electrical', 'commercial_ti' */
  projectType    String?
  /** Optional free-form location string (city/county/state). Prefer joining through Jurisdiction */
  location       String?

  applications   PermitApplication[]
}

model PermitRequirement {
  id             String       @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction @relation("JurisdictionPermitRequirements", fields: [jurisdictionId], references: [id])
  permitTypeId   String
  permitType     PermitType   @relation(fields: [permitTypeId], references: [id])
  projectType    String
  /** Human-readable rule text, e.g., "Electrical work over $500 requires permit" */
  rule           String
  /** Optional machine-readable criteria used for a conservative evaluator */
  criteria       Json?

  @@index([jurisdictionId, projectType])
  @@index([jurisdictionId, permitTypeId, projectType])
}

model PermitType {
  id             String       @id @default(uuid())
  jurisdictionId String
  jurisdiction   Jurisdiction @relation(fields: [jurisdictionId], references: [id])
  name           String

  permitRequirements PermitRequirement[]
}

model PermitApplication {
  id            String             @id @default(uuid())
  userId        String
  user          User               @relation(fields: [userId], references: [id])
  projectId     String
  project       Project            @relation(fields: [projectId], references: [id])
  data          Json
  status        ApplicationStatus  @default(SUBMITTED)
  submittedAt   DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([userId])
  @@index([projectId])
}

model AlertRule {
  id          String   @id @default(uuid())
  scope       String   @default("global")
  scopeRef    String?
  kind        String   @default("forecast_spike")
  threshold   Float    @default(0.2)
  windowHours Int      @default(24)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model ForecastLog {
  id          String   @id @default(cuid())
  triggeredAt DateTime @default(now())
  results     Json
}

model SLATask {
  id           String   @id @default(cuid())
  title        String
  description  String
  priority     String
  dueAt        DateTime
  assignedTeam String?
  status       String
  type         String
  createdAt    DateTime @default(now())
}

model SLASettings {
  id        String @id @default(cuid())
  category  String
  threshold Int
  teamId    String?
}

model ProductionModel {
  id           String   @id @default(cuid())
  modelVersion String   @unique
  stage        String
  deployedBy   String?
  deployedAt   DateTime @default(now())
  metadata     Json?
}

model Subscription {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id])
  stripeCustomerId      String
  stripeSubscriptionId  String   @unique
  status                String
  planId                String?
  currentPeriodEnd      DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Invoice {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  stripeInvoiceId  String   @unique
  amountTotal      Int?
  currency         String?
  status           String?
  hostedInvoiceUrl String?
  createdAt        DateTime @default(now())
}
